name: MNNSR for Linux (Prebuilt MNN)

on:
  push:
    branches: [ master ]
    paths:
      - 'RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/**'
      - '.github/workflows/mnnsr-linux-prebuilt.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake git wget unzip \
            libopencv-dev ocl-icd-opencl-dev clinfo \
            libvulkan-dev vulkan-tools

      - name: Create 3rdparty directory
        run: mkdir -p 3rdparty

      - name: Download and setup MNN prebuilt package (CPU + OpenCL)
        run: |
          cd 3rdparty
          wget -nv https://github.com/alibaba/MNN/releases/download/3.4.0/mnn_3.4.0_linux_x64_cpu_opencl.zip
          unzip mnn_3.4.0_linux_x64_cpu_opencl.zip
          mv mnn_3.4.0_linux_x64_cpu_opencl mnn-prebuilt

      - name: Download and setup ncnn prebuilt package
        run: |
          cd 3rdparty
          wget -nv https://github.com/Tencent/ncnn/releases/download/20250503/ncnn-20250503-ubuntu-2404-shared.zip
          unzip ncnn-20250503-ubuntu-2404-shared.zip
          mv ncnn-20250503-ubuntu-2404-shared ncnn-ubuntu-shared

      - name: Configure and build MNNSR
        run: |
          cd RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DMNN_DIR=${{ github.workspace }}/3rdparty/mnn-prebuilt/lib/cmake/MNN \
            -Dncnn_DIR=${{ github.workspace }}/3rdparty/ncnn-ubuntu-shared/lib/cmake/ncnn
          make -j$(nproc)

      - name: Prepare artifacts (executable + libraries)
        run: |
          cd RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni
          mkdir -p mnnsr/lib
          # 复制可执行文件
          cp build/mnnsr-ncnn mnnsr/
          # 复制 MNN 库
          cp ${{ github.workspace }}/3rdparty/mnn-prebuilt/lib/*.so mnnsr/lib/ 2>/dev/null || true
          # 复制 ncnn 库
          cp ${{ github.workspace }}/3rdparty/ncnn-ubuntu-shared/lib/*.so mnnsr/lib/ 2>/dev/null || true
          # 复制其他系统库（可选）
          ldd mnnsr/mnnsr-ncnn | grep "=>" | awk '{print $3}' | xargs -I {} cp -Ln {} mnnsr/lib/ 2>/dev/null || true
          # 创建运行脚本
          cat > mnnsr/run.sh << 'EOF'
#!/bin/bash
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
exec "$DIR/mnnsr-ncnn" "$@"
EOF
          chmod +x mnnsr/run.sh
          ls -lh mnnsr/

      - name: Test MNNSR (if model available)
        continue-on-error: true
        run: |
          cd RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/mnnsr
          # 下载测试图片
          wget -nv https://github.com/nihui/waifu2x-ncnn-vulkan/raw/master/images/0.jpg
          # 下载示例模型（使用 tumuyan 的 RealESRGAN）
          wget -nv https://github.com/tumuyan/RealSR-MNN/raw/master/models/RealESRGAN_x4plus.mnn -O test.mnn || echo "Model download failed"
          if [ -f test.mnn ]; then
            export LD_LIBRARY_PATH="$PWD/lib:$LD_LIBRARY_PATH"
            ./mnnsr-ncnn -b 0 -i 0.jpg -o output.png -s 4 -m test.mnn
            echo "Test completed, output.png generated"
          else
            echo "Test skipped (model not found)"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mnnsr-ubuntu24-prebuilt
          path: RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/mnnsr
          retention-days: 90
