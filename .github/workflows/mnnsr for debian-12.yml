name: MNNSR for Linux CPU (Debian 12)

on:
  push:
    branches: [ master ]
    paths:
      - 'RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/**'
      - '.github/workflows/mnnsr-linux-debian12.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential unzip cmake git wget \
            libopencv-dev ocl-icd-opencl-dev clinfo \
            libvulkan-dev vulkan-tools \
            gcc-12 g++-12
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 120 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-12
          sudo update-alternatives --install /usr/bin/cc cc /usr/bin/gcc-12 120
          sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++-12 120

      - name: Clone 3rdparty
        run: |
          git clone https://github.com/webmproject/libwebp --depth 1
          wget -nv https://github.com/CELEFT/C/releases/download/mnn/MNN-3.4-static.tar.xz
          tar -xf MNN-3.4-static.tar.xz
          # 从源码编译 ncnn，不再使用 Ubuntu 24.04 预编译包
          git clone https://github.com/Tencent/ncnn.git --depth 1 
        working-directory: 3rdparty

      - name: Build ncnn
        run: |
          cd ncnn
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DNCNN_VULKAN=ON \
            -DNCNN_BUILD_EXAMPLES=OFF \
            -DNCNN_BUILD_TOOLS=OFF \
            -DNCNN_SHARED_LIB=ON \
            -DCMAKE_INSTALL_PREFIX=../install
          make -j$(nproc)
          make install
          cd ../..
        working-directory: 3rdparty

      - name: Modify CMakeLists.txt for RPATH
        run: |
          sed -i.bak '/target_link_libraries(MNN PUBLIC -pthread dl)/a \
            set_target_properties(MNN PROPERTIES \
                BUILD_RPATH "$ORIGIN/lib" \
            )
          ' CMakeLists.txt
          grep -C 5 "target_link_libraries(MNN PUBLIC -pthread dl)" CMakeLists.txt
        working-directory: 3rdparty/MNN

      - name: Verify system
        run: |
          gcc --version
          echo "CPU cores: $(nproc)"
          pwd

      - name: Build MNN
        id: mnn
        run: |
          rm -rf build
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DMNN_TENSORRT=OFF \
            -DMNN_OPENGL=OFF \
            -DMNN_OPENCL=ON \
            -DMNN_VULKAN=ON \
            -DMNN_SEP_BUILD=OFF
          make -j$(nproc)
          mkdir ../libs
          cp -v $(find . -name "libMNN*.so") ../libs/
          ls -lh ../libs/
        working-directory: 3rdparty/MNN

      - name: Upload MNN build logs on failure
        if: steps.mnn.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: mnn-build-failure-logs-debian12
          path: |
            3rdparty/MNN/build/Makefile
          if-no-files-found: ignore
          retention-days: 1

      - name: Upload MNN build directory
        uses: actions/upload-artifact@v4
        with:
          name: mnn-build-debian12
          path: 3rdparty/MNN/build
          retention-days: 90

      - name: Build MNNSR
        run: |
          ls ../../../../../3rdparty/MNN/libs/
          mkdir -p build && cd build
          # 指定 ncnn 的安装路径和 MNN 库路径
          cmake .. \
            -Dncnn_DIR=../../../../3rdparty/ncnn/install/lib/cmake/ncnn \
            -DMNN_LIB_PATH=../../../../../3rdparty/MNN/libs
          make -j$(nproc)
          cp ../../../../../../3rdparty/MNN/libs/* ./
          chmod 777 *
          ls -lh
        working-directory: RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/

      - name: Copy libraries and prepare distribution
        continue-on-error: true
        run: |
          mkdir -p mnnsr/lib
          cp build/*.so mnnsr/lib/
          cp build/mnnsr-ncnn mnnsr/
          # 复制 ncnn 库（从编译好的安装目录复制）
          cp ../../../../3rdparty/ncnn/install/lib/libncnn.so mnnsr/lib/ || true
          ldd mnnsr/lib/libMNN.so | grep "=>" | awk '{print $3}' | xargs -I {} cp -Ln {} mnnsr/lib/ 2>/dev/null || true
          ldd mnnsr/mnnsr-ncnn | grep "=>" | awk '{print $3}' | xargs -I {} cp -Ln {} mnnsr/lib/ 2>/dev/null || true
          cp ../../../../*.md mnnsr/ 2>/dev/null || true
        working-directory: RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/

      - name: Test MNNSR with a sample image
        run: |
          wget -nv https://github.com/CELEFT/C/releases/download/mnn/4x-UltraSharpV2-fp16.mnn
          cd mnnsr
          wget https://github.com/CELEFT/C/releases/download/mnn/Magick_0216_125118.png
          LD_LIBRARY_PATH=./lib ./mnnsr-ncnn -b 0 -i Magick_0216_125118.png -o output-debian12.png -s 4 -m ../4x-UltraSharpV2-fp16.mnn
          cd ..
          cp -r mnnsr mnnsr-debian12-opencl-vulkan-cpu
        working-directory: RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/

      - name: Upload final artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mnnsr-debian12
          path: RealSR-NCNN-Android-CLI/MNN-SR/src/main/jni/mnnsr-debian12-opencl-vulkan-cpu
          retention-days: 90
